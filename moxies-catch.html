<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üíãMoxie‚Äôs Catch ‚Äî Pluto Outpost (DEV)</title>
  <style>
  /* Force monospace everywhere */
body, button, .wrap, .stats, .row, #catchReward, .subtitle, h1, .note {
  font-family: monospace !important;
}

/* Center-align text globally */
body, .wrap, .stats, .row, #catchReward, .subtitle, h1, .note {
  text-align: center;
}
  .icon-img {
  width: 100%;
  height: 100%;
  object-fit: contain;  /* keeps the right proportions */
  border-radius: 10px;   /* matches your .face rounding */
  display: block;       /* removes inline gap */
}
    :root{ --ink:#0b1220; --panel:#101a2f; --edge:#2e3e66; --cy:#6fe7ff; --glow:#33d1ff; --accent:#ffd34d; --muted:#9fb6d1; }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:linear-gradient(180deg,#0a1222,#0a1428 40%,#0c152b); color:#cfe6ff; margin:0;}
    .wrap{ max-width:620px; margin:2rem auto; padding:1.2rem 1.3rem; background:var(--panel); border-radius:14px; box-shadow:0 0 0 1px var(--edge),0 18px 40px rgba(0,0,0,.35); position:relative;}
    .banner{ height:160px; margin:-1.2rem -1.3rem 1rem; border-radius:14px 14px 0 0; background: radial-gradient(120% 100% at 70% 0%, rgba(51,209,255,.18), transparent 60%), linear-gradient(180deg,#0d1a34,#0c1426); border-bottom:1px solid var(--edge); position:relative; overflow:hidden;}
    #sky{position:absolute; inset:0; overflow:hidden;}
    .star,.light,.beacon{ position:absolute; border-radius:50%; transform:translate(-50%,-50%); }
    .star{ width:2px; height:2px; background:#9fe6ff; opacity:.6; box-shadow:0 0 6px rgba(111,231,255,.5); }
    .light{ width:3px; height:3px; background:#9fe6ff; opacity:.9; box-shadow:0 0 8px rgba(111,231,255,.6); }
    .beacon{ width:5px; height:5px; background:#ffd34d; box-shadow:0 0 10px rgba(255,211,77,.8); }
    .horizon{ position:absolute; left:0; right:0; bottom:0; height:48%;
      background: linear-gradient(0deg,#0b1020 0%, transparent 55%), repeating-linear-gradient(90deg,#0f1830 0 30px,#0b1326 30px 60px); opacity:.75; }

    h1{ margin:.25rem 0 .25rem; font-size:1.8rem; color:var(--accent); letter-spacing:.4px; }
    .subtitle{ color:var(--muted); font-size:.9rem; margin-bottom:.75rem }
    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap:.3rem .75rem; }
    .bar{ height:1px; background:linear-gradient(90deg,transparent,var(--edge),transparent); margin:.8rem 0 1.1rem; }
    .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
    .note{ color:var(--muted); font-size:.85rem }

    button{ background:#16264a; color:#cfe6ff; border:1px solid var(--edge); padding:.6rem .9rem; border-radius:10px;
      cursor:pointer; transition:transform .02s ease, filter .15s ease; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 10px 20px rgba(0,0,0,.25);}
    button:hover{ filter:brightness(1.05); } button:active{ transform:translateY(1px);} button:disabled{ opacity:.5; cursor:default;}
    .pill{ display:inline-block; padding:.05rem .45rem; border:1px solid var(--edge); border-radius:999px; color:#6fe7ff; margin-left:.35rem; font-size:.75rem; }

    /* Moxie */
    .moxie{ display:inline-flex; align-items:center; gap:.4rem; user-select:none; margin-right:.25rem; }
    .moxie .face{ width:100px; height:100px; border-radius:10px; background-color: #0b0b0f; border:1px solid #999999; display:grid; place-items:center; box-shadow:0 0 10px rgba(51,209,255,.18) inset; font-size:18px; }
    .wiggle{ animation:wiggle .45s ease; } .wiggle-epic{ animation:wiggleEpic .7s ease; } .wiggle-legend{ animation:wiggleLegend 1s ease; }
    .flash{ box-shadow:0 0 18px rgba(51,209,255,.65), 0 0 30px rgba(255,211,77,.55) inset; transition:box-shadow .35s ease; }
    @keyframes wiggle{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-1px) rotate(-6deg)}50%{transform:translateY(0) rotate(6deg)}75%{transform:translateY(-1px) rotate(-3deg)}}
    @keyframes wiggleEpic{0%,100%{transform:translateY(0) rotate(0)}20%{transform:translateY(-2px) rotate(-10deg)}50%{transform:translateY(1px) rotate(8deg)}80%{transform:translateY(-1px) rotate(-6deg)}}
    @keyframes wiggleLegend{0%,100%{transform:translateY(0) rotate(0)}15%{transform:translateY(-3px) rotate(-14deg)}45%{transform:translateY(2px) rotate(12deg)}75%{transform:translateY(-2px) rotate(-10deg)}}

    /* Toast */
    .toast{ position:fixed; top:1rem; right:1rem; background:rgba(20,45,80,.96); color:#cfe6ff; padding:.75rem 1rem; border:1px solid var(--edge); border-radius:10px; box-shadow:0 0 18px rgba(51,209,255,.25), inset 0 0 12px rgba(51,209,255,.06); font-size:.9rem; opacity:0; pointer-events:none; transition:opacity .45s ease; z-index:9999; }
    .toast.show{ opacity:1; }

    /* Active-Boost-as-Button-Fill */
    .progressBtn{ position:relative; width:240px; height:44px; border-radius:12px; background:#16264a; border:1px solid var(--edge);
      overflow:hidden; box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 10px 20px rgba(0,0,0,.25); }
    .progressBtn::before{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,#33d1ff,#ffd34d);
      transform:translateX(calc(var(--fill,0%) - 100%)); transition:transform .2s ease; filter:drop-shadow(0 0 6px rgba(255,211,77,.6)); }
    .progressBtn::after{ content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.1)); pointer-events:none; }
    .progressBtn.pulse::after{ animation:btnPulse .35s ease; }
    @keyframes btnPulse{ 0%{box-shadow:0 0 0 0 rgba(255,211,77,.55) inset} 50%{box-shadow:0 0 0 12px rgba(255,211,77,.15) inset} 100%{box-shadow:0 0 0 0 rgba(255,211,77,0) inset} }
    .progressBtn.rareBurst{ box-shadow:0 0 12px 3px #33d1ff,0 0 28px 10px rgba(51,209,255,.45); filter:saturate(1.2) brightness(1.15); }
    .progressBtn.legendaryBurst{ box-shadow:0 0 15px 5px gold,0 0 40px 15px rgba(255,215,0,.65); filter:saturate(2) brightness(1.3); }
    .progressBtn.rareFill::before{ background:linear-gradient(90deg,#6fe7ff,#33d1ff); }
    .progressBtn.legendaryFill::before{ background:linear-gradient(90deg,gold,#ff9b2f,#ff4d4d); }

    .progressBtn .fish{ position:absolute; top:50%; transform:translateY(-50%); font-size:1.3rem; white-space:nowrap; animation:swim 2.5s linear forwards; }
    @keyframes swim{ 0%{left:-2rem} 100%{left:calc(100% + 2rem)} }

    #catchReward{
  font-size:14px;
  text-align:center;
  height:18px; line-height:18px;
  margin-bottom:.35rem;
/* Reward line spacing */
  margin: .5rem 0 .35rem;
  padding: 0 .4rem;
  opacity:0; transform:translateY(4px);
  transition:opacity .25s ease, transform .25s ease;
  will-change: opacity, transform;
}

/* ü©µ Rare - sparkle sweep */
#catchReward.rareSweep {
  animation: rareSparkle 0.8s ease-in-out;
}
@keyframes rareSparkle {
  0%   { text-shadow: 0 0 10px rgba(51, 209, 255, .6); }
  25%  { text-shadow: 0 0 16px rgba(111, 231, 255, .8), 0 0 30px rgba(51, 209, 255, .5); }
  50%  { text-shadow: 0 0 22px rgba(51, 209, 255, 1), 0 0 40px rgba(111, 231, 255, .8); }
  75%  { text-shadow: 0 0 16px rgba(111, 231, 255, .8), 0 0 30px rgba(51, 209, 255, .5); }
  100% { text-shadow: 0 0 10px rgba(51, 209, 255, .6); }
}

/* üíú Legendary - gentle pulse (if you want it too) */
#catchReward.legendaryPulse {
  animation: legendaryPulse 1s ease-in-out;
}
@keyframes legendaryPulse {
  0%   { text-shadow: 0 0 12px rgba(255,211,77,.6); }
  50%  { text-shadow: 0 0 18px rgba(255,211,77,.9), 0 0 28px rgba(255,155,47,.5); }
  100% { text-shadow: 0 0 12px rgba(255,211,77,.6); }
}

/* show/hide */
#catchReward.show{ opacity:1; transform:translateY(0); }

/* tint by rarity */
#catchReward.r-common    { color:#9fb6d1; } /* muted blue */
#catchReward.r-uncommon  { color:#6fe7ff; } /* cyan */
#catchReward.r-rare      { color:#33d1ff; text-shadow:0 0 10px rgba(51,209,255,.6); }
#catchReward.r-legendary { color:#ffd34d; text-shadow:0 0 14px rgba(255,211,77,.7), 0 0 22px rgba(255,155,47,.45); }

    /* DEV PANEL */
    #devToggle{ position:fixed; bottom:16px; right:16px; z-index:10000; border-radius:12px; padding:.6rem .8rem; }
    #devPanel{ position:fixed; bottom:70px; right:16px; width:320px; max-height:75vh; overflow:auto; background:rgba(16,26,47,.98); border:1px solid var(--edge); border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.04) inset; padding:.8rem; z-index:9999; display:none; }
    #devPanel h4{ margin:.2rem 0 .4rem; color:var(--accent); }
    #devPanel label{ display:flex; justify-content:space-between; gap:.5rem; font-size:.85rem; margin:.35rem 0; }
    #devPanel input{ width:110px; background:#0e1a34; color:#cfe6ff; border:1px solid var(--edge); border-radius:8px; padding:.25rem .35rem; }
    #devPanel .row{ justify-content:space-between; }
    #devPanel .btns{ display:flex; gap:.5rem; margin-top:.5rem; }
    .stats { justify-items: center; }
    
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner"><div id="sky"></div><div class="horizon"></div></div>

    <h1>Moxie‚Äôs Catch</h1>
    <div class="subtitle">Pluto Observatory District</div>

    <div class="stats">
      <div>ThiccTokens‚Ñ¢: <span id="coins">0</span></div>
      <div>Tokens / sec: <span id="cps">0</span></div>
      <div>Booty per Hour (BPH): <span id="bph">0</span></div>
      <div>Catchmastery: <span id="catch">0</span></div>
      <div>ŒûSigils: <span id="sigil">0</span></div>
      <div>Total Multiplier: <span id="mult">1.00√ó</span></div>
      <div>Mastery Bonus: <span id="mastery">+0.000% (0 lvls)</span></div>
      <div>Buffs: <span id="buffs">‚Äî</span></div>
      <div id="playtime" style="margin-top:6px;">00:00:00</div>
    </div>

    <div class="bar"></div>

    <div class="row" style="justify-content:center">
      <span class="moxie"><span id="moxFace" class="face"><img src="images/IMG_8795.jpeg" alt="Peach" class="icon-img"></span></span>
      <button id="catchBtn" class="progressBtn" aria-label="Reel in the Thick"></button>
    </div>
    <div id="catchReward"></div>

    <div class="row" style="margin-top:.6rem" id="upgradeRow"></div>

    <div class="bar"></div>
    <h3 style="margin:.2rem 0 .4rem;color:#ffd34d">Ancients</h3>
    <div class="note" style="margin-bottom:.4rem">Spend ŒûSigils on permanent, exponential buffs.</div>
    <div id="ancientRow"></div>

    <div class="bar"></div>

    <div class="row" style="margin-top:.6rem">
      <button id="prestigeBtn">üí† Sell the Haul</button>
      <small class="note">Prestige for Œû‚ÄëSigils (permanent +5% BPH each)</small>
    </div>

    <div class="row" style="margin-top:.6rem">
      <button id="saveBtn">üìú Seal the Scroll</button>
      <button id="resetBtn">üîÑ Banish to the Depths</button>
      <span class="pill">auto‚Äësave</span>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- DEV PANEL -->
  <button id="devToggle">üõ†Ô∏è Dev</button>
  <div id="devPanel">
    <h4>Dev Tuning Hub</h4>
    <div class="section">
      <strong>Prestige</strong>
      <label>Divisor (TT per Œû) <input id="t_prestigeDivisor" type="number" step="1"></label>
      <label>BPH per Œû (0.05=5%) <input id="t_prestigeBphPerSigil" type="number" step="0.01"></label>
      <label>Shark +% per lvl <input id="t_sharkPerLevel" type="number" step="0.001"></label>
    </div>
    <div class="section">
      <strong>Active Boost</strong>
      <label>Base Cap <input id="t_sparkBase" type="number" step="0.01"></label>
      <label>Cap / Spark lvl <input id="t_sparkPerLevel" type="number" step="0.01"></label>
      <label>Click Fill (0‚Äë1) <input id="t_activeClickFill" type="number" step="0.01" min="0" max="1"></label>
      <label>Drain / sec (0‚Äë1) <input id="t_activeDrainPerSec" type="number" step="0.01" min="0" max="1"></label>
    </div>
    <div class="section">
      <strong>Netmother</strong>
      <label>+BPH per Net/lvl <input id="t_netmotherPerNetPerLevel" type="number" step="1"></label>
    </div>
    <div class="section">
      <strong>Gear Prices</strong>
      <label>Net Start <input id="t_priceNet" type="number" step="1"></label>
      <label>Rod Start <input id="t_priceRod" type="number" step="1"></label>
      <label>Trawler Start <input id="t_priceTrawl" type="number" step="1"></label>
      <label>Net Scale <input id="t_scaleNet" type="number" step="0.01"></label>
      <label>Rod Scale <input id="t_scaleRod" type="number" step="0.01"></label>
      <label>Trawler Scale <input id="t_scaleTrawl" type="number" step="0.01"></label>
    </div>
    <div class="section">
      <strong>Rarity (sum ‚âà 1)</strong>
      <label>Common <input id="t_r_common" type="number" step="0.01" min="0" max="1"></label>
      <label>Uncommon <input id="t_r_uncommon" type="number" step="0.01" min="0" max="1"></label>
      <label>Rare <input id="t_r_rare" type="number" step="0.001" min="0" max="1"></label>
      <label>Legendary <input id="t_r_legendary" type="number" step="0.001" min="0" max="1"></label>
    </div>
    <div class="section">
      <strong>Rewards</strong>
      <label>Common BPH <input id="t_rw_c_bph" type="number" step="1"></label>
      <label>Common TT <input id="t_rw_c_tt" type="number" step="1"></label>
      <label>Rare BPH <input id="t_rw_r_bph" type="number" step="1"></label>
      <label>Rare TT <input id="t_rw_r_tt" type="number" step="1"></label>
      <label>Legendary BPH <input id="t_rw_l_bph" type="number" step="1"></label>
      <label>Legendary TT <input id="t_rw_l_tt" type="number" step="1"></label>
      <label>Legendary Frenzy x <input id="t_rw_l_mult" type="number" step="0.1"></label>
      <label>Legendary Frenzy s <input id="t_rw_l_secs" type="number" step="1"></label>
    </div>
    <div class="btns">
      <button id="t_save">üíæ Save TUNE</button>
      <button id="t_reset">üßΩ Defaults</button>
      <button id="t_close">Close</button>
    </div>
    <small class="note">Tip: Press ‚åò to toggle panel.</small>
  </div>

  <script>
    /* =========================
       DEV TUNE STORAGE / DEFAULTS
       ========================= */
    const TUNE_DEFAULTS = {
      prestigeDivisor: 1000,
      prestigeBphPerSigil: 0.05,
      sharkPerLevel: 0.05,       // +5% per level (compounding)
      activeClickFill: 0.12,
      activeDrainPerSec: 0.05,
      sparkBase: 1.50,
      sparkPerLevel: 0.05,
      netmotherPerNetPerLevel: 2,
      startPrice: { net:100, rod:250, trawl:400 },
      scale: { net:1.25, rod:1.35, trawl:1.40 },
      rarity: { common:0.80, uncommon:0.15, rare:0.04, legendary:0.01 },
      rewards: {
        common:    { bph:3,  coins:0 },
        uncommon:  { bph:3,  coins:50 },
        rare:      { bph:10, coins:250 },
        legendary: { bph:25, coins:1000, buff:{mult:1.5, secs:60} }
      }
    };
    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
    function loadTune(){ const raw = localStorage.getItem('moxies-tune'); if(!raw) return deepClone(TUNE_DEFAULTS); try{ const got=JSON.parse(raw); return Object.assign(deepClone(TUNE_DEFAULTS), got); }catch{ return deepClone(TUNE_DEFAULTS); } }
    function saveTune(){ localStorage.setItem('moxies-tune', JSON.stringify(TUNE)); }
    function resetTune(){ TUNE = deepClone(TUNE_DEFAULTS); saveTune(); applyTuneToUI(); regenerateRarity(); render(); toast('TUNE reset to defaults.'); }

    // live TUNE
    let TUNE = loadTune();

    /* =========================
       HELPERS
       ========================= */
    const $ = id => document.getElementById(id);
    const fmt = n => n.toLocaleString(undefined,{maximumFractionDigits:2});
    const toast = (msg, ms=3200) => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms); };

    function spawnFish(emoji){ const btn=$('catchBtn'); const s=document.createElement('span'); s.className='fish'; s.textContent=emoji; btn.appendChild(s); setTimeout(()=>s.remove(),2500); }
    function addBurst(type){ const btn=$('catchBtn'); btn.classList.remove('rareBurst','legendaryBurst','rareFill','legendaryFill'); void btn.offsetWidth;
      if (type==='rare') btn.classList.add('rareBurst','rareFill'); if (type==='legendary') btn.classList.add('legendaryBurst','legendaryFill');
      setTimeout(()=>btn.classList.remove('rareBurst','legendaryBurst','rareFill','legendaryFill'),1800);
    }

    /* =========================
       STATE
       ========================= */
    const S = {
      coins:0, bph:0, catch:0,
      nets:0, rods:0, trawlers:0,
      netPrice:TUNE.startPrice.net, rodPrice:TUNE.startPrice.rod, trawlPrice:TUNE.startPrice.trawl,
      lifetimeUpgrades:0,
      sigil:0, tempMult:1, tempUntil:0,
      activeFill:0,
      ancients:{ tide:0, spark:0, netmother:0, lucky:0, shark:0 },
      lastTick:Date.now()
    };
    const saved = localStorage.getItem('moxies-catch'); if (saved) Object.assign(S, JSON.parse(saved));
// existing: your S object and save/load setup here...

// --- Playtime tracker (drop‚Äëin) ---
(function(){
  // state
  if (S.playedMs == null) S.playedMs = 0;
  if (S.lastSeen  == null) S.lastSeen  = Date.now();

  // count offline time since last visit
  {
    const now = Date.now();
    const offlineMs = Math.max(0, now - S.lastSeen);
    S.playedMs += offlineMs;
    S.lastSeen  = now;
  }

  // formatter HH:MM:SS
  function formatPlaytime(ms){
    let sec = Math.floor(ms / 1000);
    const hrs  = Math.floor(sec / 3600); sec -= hrs * 3600;
    const mins = Math.floor(sec / 60);   sec -= mins * 60;
    return `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }

  // draw once immediately
  const draw = () => {
    const el = document.getElementById('playtime');
    if (el) el.textContent = formatPlaytime(S.playedMs);
  };
  draw();

  // own ticker: uses real elapsed time (not tied to your game loop)
  let prev = Date.now();
  setInterval(() => {
    const now = Date.now();
    S.playedMs += Math.max(0, now - prev); // add real delta
    S.lastSeen  = now;
    prev = now;
    draw();
    // keep it persisted (lightweight)
    localStorage.setItem('moxies-catch', JSON.stringify(S));
  }, 1000);
})();
    /* =========================
       ANCients
       ========================= */
    const ANCIENTS = [
      { key:'tide', name:'Tidecaller', desc:'Global production multiplier (exponential).', baseCost:5, scale:2.0, effectMult:lvl => Math.pow(1.15, lvl) },
      { key:'spark', name:'Spark of Moxie', desc:'Raises Active Boost cap by +0.05√ó per level.', baseCost:3, scale:2.5 },
      { key:'netmother', name:'Netmother', desc:'Adds +2 BPH per Net per level (additive).', baseCost:4, scale:2.2 },
      { key:'lucky', name:'Lucky Current', desc:'Boosts chances for Rare/Legendary catches.', baseCost:6, scale:2.4 },
      { key:'shark', name:'Ledger Shark ü¶à', desc:'Earn compounding +5% Œû on ‚ÄúSell the Haul‚Äù (√ó1.05^lvl).', baseCost:8, scale:2.6 }
    ];
    const ancientLevel = k => S.ancients[k] || 0;
    const ancientCost = a => Math.ceil(a.baseCost * Math.pow(a.scale, ancientLevel(a.key)));
    const ancientsMult = () => ANCIENTS.reduce((m,a)=> a.effectMult ? m * a.effectMult(ancientLevel(a.key)) : m, 1);

    /* =========================
       MULTIPLIERS (from TUNE)
       ========================= */
    const BOOST_PER_UPGRADE = 0.00001; // you can add this to TUNE later if you want
    function totalUpgradeLevels(){ return S.lifetimeUpgrades || 0; }
    function masteryMult(){ return 1 + totalUpgradeLevels() * BOOST_PER_UPGRADE; }
    const prestigeMult  = () => 1 + (S.sigil * TUNE.prestigeBphPerSigil);

    function activeMaxMult(){ return TUNE.sparkBase + TUNE.sparkPerLevel * ancientLevel('spark'); }
    function activeMult(){ return 1 + (activeMaxMult() - 1) * Math.max(0, Math.min(1, S.activeFill)); }
    function netmotherBPH(){ return TUNE.netmotherPerNetPerLevel * ancientLevel('netmother') * S.nets; }

    function ancientsGlobalMult(){ return ancientsMult(); }
    function effectiveMult(){ return prestigeMult() * S.tempMult * masteryMult() * ancientsGlobalMult() * activeMult(); }
    function cps(){ const base = S.bph + netmotherBPH(); return (base * effectiveMult()) / 3600; }

    /* Ledger Shark ‚Äî compounding using TUNE */
    function sigilGainMult(){ return Math.pow(1 + TUNE.sharkPerLevel, ancientLevel('shark')); }

    /* =========================
       SKYLINE
       ========================= */
    function updateSkyline(){
      const sky = $('sky'); sky.innerHTML = '';
      const tier = S.sigil; const stars = 40 + tier*15, lights = 10 + tier*6, beacons = Math.floor(tier/2);
      const rand = (min,max)=>Math.random()*(max-min)+min;
      for(let i=0;i<stars;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=rand(2,98)+'%'; s.style.top=rand(5,55)+'%'; sky.appendChild(s); }
      for(let i=0;i<lights;i++){ const l=document.createElement('div'); l.className='light'; l.style.left=rand(2,98)+'%'; l.style.top=rand(55,92)+'%'; sky.appendChild(l); }
      for(let i=0;i<beacons;i++){ const b=document.createElement('div'); b.className='beacon'; b.style.left=rand(5,95)+'%'; b.style.top=rand(35,70)+'%'; sky.appendChild(b); }
    }

    /* =========================
       OFFLINE PROGRESS
       ========================= */
    (function offline(){
      const now = Date.now(); const dt = Math.max(0, (now - (S.lastTick||now)) / 1000);
      const CAP_HOURS = 12; const capped = Math.min(dt, CAP_HOURS*3600); const earned = cps() * capped;
      if (earned > 0.01 && capped > 0){ S.coins += earned; setTimeout(()=>toast(`While you drifted among Pluto‚Äôs moons (${fmt(capped/3600)}h), Moxie‚Äôs crew hauled ${fmt(earned)} ThiccTokens‚Ñ¢ from the currents.`), 120); }
      S.lastTick = now;
    })();

    /* =========================
       LOOP
       ========================= */
    function loop(){
      const now = Date.now(); const dt = (now - S.lastTick) / 1000; S.lastTick = now;
      if (S.tempMult > 1 && now >= S.tempUntil){ S.tempMult = 1; }
      S.activeFill = Math.max(0, S.activeFill - TUNE.activeDrainPerSec * Math.min(dt, 1));
      S.coins += cps() * Math.min(dt, 60);
      render();
    }
    setInterval(loop, 1000);

    /* =========================
       RARITY + REWARDS (from TUNE)
       ========================= */
    let BASE_RARITY = [];
    function regenerateRarity(){
      const R = TUNE.rarity, W = TUNE.rewards;
      BASE_RARITY = [
        { name:'Common',    prob:R.common,    wiggle:'wiggle',        flash:false,  bph:+W.common.bph,    coins:+W.common.coins,    buff:null,               emoji:'ü§ç' },
        { name:'Uncommon',  prob:R.uncommon,  wiggle:'wiggle',        flash:false,  bph:+W.uncommon.bph,  coins:+W.uncommon.coins,  buff:null,               emoji:'üíö' },
        { name:'Rare',      prob:R.rare,      wiggle:'wiggle-epic',   flash:true,   bph:+W.rare.bph,      coins:+W.rare.coins,      buff:null,               emoji:'ü©µ' },
        { name:'Legendary', prob:R.legendary, wiggle:'wiggle-legend', flash:true,   bph:+W.legendary.bph, coins:+W.legendary.coins, buff:W.legendary.buff,   emoji:'üíú' }
      ];
    }
    regenerateRarity();

    function adjustedRarity(){
      const L = ancientLevel('lucky'); if (!L) return BASE_RARITY;
      // boosts toward higher rarities; mild nerf to common via inverse
      const mults = { Common: 1/(1+0.15*L), Uncommon: 1+0.08*L, Rare: 1+0.20*L, Legendary: 1+0.35*L };
      const raw = BASE_RARITY.map(t => ({...t, prob: t.prob * (mults[t.name] || 1)}));
      const sum = raw.reduce((a,t)=>a+t.prob,0);
      return raw.map(t => ({...t, prob: t.prob / sum}));
    }
    function rollRarity(){ const table = adjustedRarity(); const r = Math.random(); let acc = 0; for (const t of table){ acc += t.prob; if (r <= acc) return t; } return table[0]; }

// ---- Gear gains & milestones (tweak here)
const TUNE_GEAR = {
  yields: { net: 50, rod: 100, trawl: 300 }, // base +BPH per purchase
  milestones: [
    { at: 10,  mult: 1.5 },
    { at: 25,  mult: 2.0 },
    { at: 50,  mult: 3.0 },
    { at: 100, mult: 5.0 },
    { at: 111, mult: 1.11 },
    { at: 222, mult: 2.22 },
    { at: 333, mult: 3.33 },
    { at: 500, mult: 6.0 },
    { at: 555, mult: 5.55 },
    { at: 666, mult: 6.66 },
  ],
};

// next-level milestone multiplier (1 if none)
function nextMilestoneMult(nextLevel){
  const m = TUNE_GEAR.milestones.find(ms => ms.at === nextLevel);
  return m ? m.mult : 1;
}

// pretty suffix used in the note
function milestoneSuffix(nextLevel){
  const m = TUNE_GEAR.milestones.find(ms => ms.at === nextLevel);
  return m ? ` ‚Äî üéâ Milestone √ó${m.mult}` : '';
}

// compute +BPH the *next* purchase will grant for a given gear key
function nextBphGainFor(key){
  let base, nextLevel;
  if (key === 'nets'){ base = TUNE_GEAR.yields.net; nextLevel = S.nets + 1; }
  else if (key === 'rods'){ base = TUNE_GEAR.yields.rod; nextLevel = S.rods + 1; }
  else { base = TUNE_GEAR.yields.trawl; nextLevel = S.trawlers + 1; }
  return Math.round(base * nextMilestoneMult(nextLevel));
}

    /* =========================
       UPGRADES
       ========================= */
    const upgrades = [
  {
    key:'nets', id:'netBtn', name:'‚öì Curvature Lattice',
    get price(){ return S.netPrice; },
    canBuy:()=> S.coins >= S.netPrice,
    buy:()=>{
      const gain = nextBphGainFor('nets');
      S.coins -= S.netPrice;
      S.nets += 1;
      S.lifetimeUpgrades += 1;
      S.bph += gain;
      S.netPrice = Math.ceil(S.netPrice * TUNE.scale.net);
    },
    label:()=>`‚öì Curvature Lattice (${S.netPrice} TT)`,
    note:()=>`Level ${S.nets} ‚Äî next: +${nextBphGainFor('nets')} BPH${milestoneSuffix(S.nets+1)}`
  },

  {
    key:'rods', id:'rodBtn', name:'üé£ Cosmic Rod',
    get price(){ return S.rodPrice; },
    canBuy:()=> S.nets >= 3 && S.coins >= S.rodPrice,
    buy:()=>{
      const gain = nextBphGainFor('rods');
      S.coins -= S.rodPrice;
      S.rods += 1;
      S.lifetimeUpgrades += 1;
      S.bph += gain;
      S.rodPrice = Math.ceil(S.rodPrice * TUNE.scale.rod);
    },
    label:()=>`üé£ Cosmic Rod (${S.rodPrice} TT)`,
    note:()=>`Level ${S.rods} ‚Äî next: +${nextBphGainFor('rods')} BPH${milestoneSuffix(S.rods+1)}`
  },

  {
    key:'trawlers', id:'trawlBtn', name:'üõ†Ô∏è Quantum Trawler',
    get price(){ return S.trawlPrice; },
    canBuy:()=> S.nets >= 2 && S.coins >= S.trawlPrice,
    buy:()=>{
      const gain = nextBphGainFor('trawlers');
      S.coins -= S.trawlPrice;
      S.nets -= 2;
      S.trawlers += 1;
      S.lifetimeUpgrades += 1;
      S.bph += gain;
      S.trawlPrice = Math.ceil(S.trawlPrice * TUNE.scale.trawl);
    },
    label:()=>`üõ†Ô∏è Quantum Trawler (${S.trawlPrice} TT)`,
    note:()=>`Level ${S.trawlers} ‚Äî next: +${nextBphGainFor('trawlers')} BPH${milestoneSuffix(S.trawlers+1)}`
  }
];
    function renderUpgrades(){
      const row=$('upgradeRow'); row.innerHTML='';
      upgrades.forEach(u=>{
        const btn=document.createElement('button'); btn.id=u.id; btn.textContent=u.label(); btn.disabled=!u.canBuy();
        btn.onclick=()=>{ if(!u.canBuy()) return toast('Requirements not met.'); u.buy(); save(); render(); };
        const info=document.createElement('small'); info.className='note'; info.textContent = (typeof u.note === 'function') ? u.note() : u.note;
        const wrap=document.createElement('div'); wrap.className='row'; wrap.style.marginTop='.4rem';
        wrap.appendChild(btn); wrap.appendChild(info); row.appendChild(wrap);
      });
    }

    /* =========================
       ANCIENTS UI
       ========================= */
    function renderAncients(){
      const wrap=$('ancientRow'); wrap.innerHTML='';
      ANCIENTS.forEach(a=>{
        const lvl=ancientLevel(a.key); const cost=ancientCost(a);
        const row=document.createElement('div'); row.className='row'; row.style.marginTop='.35rem';

        const btn=document.createElement('button');
        btn.textContent=`${a.name} ‚Äî Invoke (${cost} Œû)`; btn.disabled=S.sigil<cost;
        btn.onclick=()=>{ if(S.sigil<cost) return toast('Not enough sigils.');
          S.sigil-=cost; S.ancients[a.key]=lvl+1; save(); render(); toast(`${a.name} ascends to level ${S.ancients[a.key]}!`); };

        const info=document.createElement('small'); info.className='note';
        let effectText=a.desc;
        if(a.key==='spark'){ effectText+=` Current cap: x${activeMaxMult().toFixed(2)} (lvl ${lvl})`; }
        else if(a.key==='netmother'){ effectText+=` Current bonus: +${(TUNE.netmotherPerNetPerLevel*lvl)} BPH per Net (lvl ${lvl})`; }
        else if(a.key==='tide'){ effectText+=` Current: √ó${(a.effectMult?a.effectMult(lvl):1).toFixed(3)} (lvl ${lvl})`; }
        else if(a.key==='lucky'){ effectText+=` Lvl ${lvl} (rarer catches more likely)`; }
        else if(a.key==='shark'){ const bonusPct=(sigilGainMult()-1)*100; effectText+=` Current bonus: +${bonusPct.toFixed(2)}% sigils (lvl ${lvl})`; }

        info.textContent=effectText;
        row.appendChild(btn); row.appendChild(info); wrap.appendChild(row);
      });
    }

    /* =========================
       ACTIONS
       ========================= */
    $('catchBtn').onclick=()=>{
      const tier=rollRarity();
      S.catch+=1; S.bph+=tier.bph; S.coins+=tier.coins;
      if(tier.buff){ const {mult,secs}=tier.buff; S.tempMult=mult; S.tempUntil=Date.now()+secs*1000; }

      // active fill + pulse
      S.activeFill=Math.min(1,S.activeFill+TUNE.activeClickFill);
      const pct=Math.round(Math.max(0,Math.min(1,S.activeFill))*100);
      $('catchBtn').style.setProperty('--fill', pct+'%');
      const btn=$('catchBtn'); btn.classList.remove('pulse'); void btn.offsetWidth; btn.classList.add('pulse');

      // Moxie wiggle
      const face=$('moxFace'); face.classList.remove('wiggle','wiggle-epic','wiggle-legend','flash'); void face.offsetWidth; face.classList.add(tier.wiggle);
      if(tier.flash){ face.classList.add('flash'); setTimeout(()=>face.classList.remove('flash'), 400); }

      // flair
      if(tier.name==='Rare'){ spawnFish('üêü'); addBurst('rare'); }
      if(tier.name==='Legendary'){ spawnFish('üê†‚ú®'); addBurst('legendary'); }

      const rewardBits = [
  `${tier.emoji}`,
  `+${tier.bph} BPH`,
  tier.coins ? `+${fmt(tier.coins)} TT` : null,
  tier.buff ? `Frenzy x${tier.buff.mult} ${tier.buff.secs}s` : null
].filter(Boolean).join('|');
      const rewardEl = $('catchReward');

// rarity ‚Üí class + linger time
const classByRarity = {
  Common: 'r-common',
  Uncommon: 'r-uncommon',
  Rare: 'r-rare',
  Legendary: 'r-legendary'
};
const durationByRarity = {
  Common: 1600,
  Uncommon: 4000,
  Rare: 6000,
  Legendary: 9000
};

// apply text + rarity styling
rewardEl.textContent = rewardBits;
rewardEl.className = ''; // clear any previous rarity/show classes
rewardEl.classList.add(classByRarity[tier.name] || 'r-common', 'show');
// trigger one-off animations by rarity
rewardEl.classList.remove('rareSweep','legendaryPulse'); // reset any previous
if (tier.name === 'Rare')       rewardEl.classList.add('rareSweep');
if (tier.name === 'Legendary')  rewardEl.classList.add('legendaryPulse');

// handle linger + fade-out
clearTimeout(rewardEl._hideTimer);
rewardEl._hideTimer = setTimeout(()=>{
  rewardEl.classList.remove('show');           // start fade
  setTimeout(()=>{ rewardEl.textContent=''; }, 300); // clear after fade
}, durationByRarity[tier.name] || 1800);
      render();
    };

    function updatePrestigePreview(){
      const baseSigils = S.coins / TUNE.prestigeDivisor;
      const preview = Math.floor(baseSigils * sigilGainMult());
      $('prestigeBtn').textContent = `üí† Sell the Haul (+${fmt(preview)} Œû)`;
    }

    function prestige(){
      const baseSigils = S.coins / TUNE.prestigeDivisor;
      const earned = Math.floor(baseSigils * sigilGainMult());
      if(earned<=0) return toast('Haul not big enough to impress Moxie.');
      if(!confirm(`Sell your entire haul for ${earned} Œû‚ÄëSigil(s)? This resets your catch and gear.`)) return;
      S.sigil += earned;
      // reset gear/baselines to TUNE starts
      S.coins=0; S.bph=0; S.catch=0; S.nets=0; S.rods=0; S.trawlers=0;
      S.netPrice=TUNE.startPrice.net; S.rodPrice=TUNE.startPrice.rod; S.trawlPrice=TUNE.startPrice.trawl;
      S.tempMult=1; S.tempUntil=0; S.activeFill=0;
      save(); render(); toast(`Trade complete. ${earned} Œû‚ÄëSigil(s) etched into your soul.`);
    }
    $('prestigeBtn').onclick=prestige;

    /* =========================
       SAVE / RESET / RENDER
       ========================= */
    function save(){ localStorage.setItem('moxies-catch', JSON.stringify(S)); }
    $('saveBtn').onclick=()=>{ save(); toast('Scroll sealed. Progress preserved.'); };
    $('resetBtn').onclick=()=>{ if(!confirm('Banish all progress to the depths?')) return; localStorage.removeItem('moxies-catch'); location.reload(); };
    setInterval(save,15000);

    function render(){
      $('coins').textContent = fmt(S.coins);
      $('cps').textContent   = fmt(cps());
      $('bph').textContent   = fmt(S.bph + netmotherBPH());
      $('catch').textContent = S.catch;
      $('sigil').textContent = S.sigil;
      $('mult').textContent  = fmt(effectiveMult()) + '√ó';

      const masteryPct = ((masteryMult()-1)*100);
      $('mastery').textContent = `+${masteryPct.toFixed(3)}% (${totalUpgradeLevels()} lvls)`;

      if(S.tempMult>1){ const secs=Math.max(0,Math.ceil((S.tempUntil-Date.now())/1000)); $('buffs').textContent=`| Frenzy x${S.tempMult} (${secs}s)`; }
      else $('buffs').textContent='|';

      const pct = Math.round(Math.max(0, Math.min(1, S.activeFill)) * 100);
      $('catchBtn').style.setProperty('--fill', pct + '%');

      renderUpgrades();
      renderAncients();
      updateSkyline();
      updatePrestigePreview();

      upgrades.forEach(u=>{ const b=$(u.id); if(b) b.disabled=!u.canBuy(); });
    }

    updateSkyline(); render();

    /* =========================
       DEV PANEL WIRING
       ========================= */
    function applyTuneToUI(){
      $('t_prestigeDivisor').value = TUNE.prestigeDivisor;
      $('t_prestigeBphPerSigil').value = TUNE.prestigeBphPerSigil;
      $('t_sharkPerLevel').value = TUNE.sharkPerLevel;

      $('t_sparkBase').value = TUNE.sparkBase;
      $('t_sparkPerLevel').value = TUNE.sparkPerLevel;
      $('t_activeClickFill').value = TUNE.activeClickFill;
      $('t_activeDrainPerSec').value = TUNE.activeDrainPerSec;

      $('t_netmotherPerNetPerLevel').value = TUNE.netmotherPerNetPerLevel;

      $('t_priceNet').value = TUNE.startPrice.net;
      $('t_priceRod').value = TUNE.startPrice.rod;
      $('t_priceTrawl').value = TUNE.startPrice.trawl;
      $('t_scaleNet').value = TUNE.scale.net;
      $('t_scaleRod').value = TUNE.scale.rod;
      $('t_scaleTrawl').value = TUNE.scale.trawl;

      $('t_r_common').value = TUNE.rarity.common;
      $('t_r_uncommon').value = TUNE.rarity.uncommon;
      $('t_r_rare').value = TUNE.rarity.rare;
      $('t_r_legendary').value = TUNE.rarity.legendary;

      $('t_rw_c_bph').value = TUNE.rewards.common.bph;
      $('t_rw_c_tt').value = TUNE.rewards.common.coins;
      $('t_rw_r_bph').value = TUNE.rewards.rare.bph;
      $('t_rw_r_tt').value = TUNE.rewards.rare.coins;
      $('t_rw_l_bph').value = TUNE.rewards.legendary.bph;
      $('t_rw_l_tt').value = TUNE.rewards.legendary.coins;
      $('t_rw_l_mult').value = TUNE.rewards.legendary.buff.mult;
      $('t_rw_l_secs').value = TUNE.rewards.legendary.buff.secs;
    }
    function pullUIToTune(){
      TUNE.prestigeDivisor = +$('t_prestigeDivisor').value;
      TUNE.prestigeBphPerSigil = +$('t_prestigeBphPerSigil').value;
      TUNE.sharkPerLevel = +$('t_sharkPerLevel').value;

      TUNE.sparkBase = +$('t_sparkBase').value;
      TUNE.sparkPerLevel = +$('t_sparkPerLevel').value;
      TUNE.activeClickFill = +$('t_activeClickFill').value;
      TUNE.activeDrainPerSec = +$('t_activeDrainPerSec').value;

      TUNE.netmotherPerNetPerLevel = +$('t_netmotherPerNetPerLevel').value;

      TUNE.startPrice.net = +$('t_priceNet').value;
      TUNE.startPrice.rod = +$('t_priceRod').value;
      TUNE.startPrice.trawl = +$('t_priceTrawl').value;
      TUNE.scale.net = +$('t_scaleNet').value;
      TUNE.scale.rod = +$('t_scaleRod').value;
      TUNE.scale.trawl = +$('t_scaleTrawl').value;

      TUNE.rarity.common = +$('t_r_common').value;
      TUNE.rarity.uncommon = +$('t_r_uncommon').value;
      TUNE.rarity.rare = +$('t_r_rare').value;
      TUNE.rarity.legendary = +$('t_r_legendary').value;

      TUNE.rewards.common.bph = +$('t_rw_c_bph').value;
      TUNE.rewards.common.coins = +$('t_rw_c_tt').value;
      TUNE.rewards.rare.bph = +$('t_rw_r_bph').value;
      TUNE.rewards.rare.coins = +$('t_rw_r_tt').value;
      TUNE.rewards.legendary.bph = +$('t_rw_l_bph').value;
      TUNE.rewards.legendary.coins = +$('t_rw_l_tt').value;
      TUNE.rewards.legendary.buff.mult = +$('t_rw_l_mult').value;
      TUNE.rewards.legendary.buff.secs = +$('t_rw_l_secs').value;
    }

    function applyTuneLive(){
      // update dependent runtime values
      regenerateRarity();
      // If prices changed, only apply on fresh runs or manual prestige; we keep current prices as-is.
      updatePrestigePreview();
      render();
    }

    // Dev panel events
    $('t_save').onclick = () => { pullUIToTune(); saveTune(); applyTuneLive(); toast('TUNE saved.'); };
    $('t_reset').onclick = () => { if(confirm('Reset all TUNE values to defaults?')) resetTune(); };
    $('t_close').onclick = () => { $('devPanel').style.display = 'none'; };

    $('devToggle').onclick = () => {
      const p = $('devPanel');
      p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
      if (p.style.display === 'block') applyTuneToUI();
    };
    // Keyboard toggle: Ctrl/‚åò + `
    document.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key === '`'){
        $('devToggle').click();
        e.preventDefault();
      }
    });

    // init UI with current TUNE
    applyTuneToUI();
  </script>
</body>
</html>